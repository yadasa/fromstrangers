<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flippable Ticket + Live QR + Modal</title>
  <style>
    /* prevent selection */
    html, body, #ticketContainer, #ticketContainer *, #modalOverlay, #modalOverlay * {
        user-select: none;
        -webkit-user-select: none;
    }
    html, body {
        margin:0; padding:0;
        width:100%; height:100%;
        background:#ece3d6;
    }
    body {
        display:flex;
        justify-content:center;
        align-items:center;
    }

    /* Flip container */
    #ticketContainer {
        -webkit-perspective: 1000px;
                perspective: 1000px;
        display:inline-block;
        overflow:visible;
    }
    #ticketContainer .flipper {
        position:relative;
        width:100%; height:100%;
        -webkit-transform-style: preserve-3d;
                transform-style: preserve-3d;
        will-change: transform;
        -webkit-transform: rotateY(180deg) translateZ(0);
                transform: rotateY(180deg) translateZ(0);
        -webkit-transition: -webkit-transform 0.6s;
                transition: transform 0.6s;
        cursor:pointer;
    }
    /* when “flipped” class is present: rotate to 0°, showing front */
    #ticketContainer.flipped .flipper {
        -webkit-transform: rotateY(0deg) translateZ(0);
                transform: rotateY(0deg) translateZ(0);
    }

    /* Front & back faces */
    #ticketContainer .front,
    #ticketContainer .back {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        display:flex;
        justify-content:center;
        align-items:center;
        -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
        will-change: transform, opacity;
    }
    /* front face */
    #ticketContainer .front {
        z-index:2;
        -webkit-transform: rotateY(0deg) translateZ(0.1px);
                transform: rotateY(0deg) translateZ(0.1px);
    }
    /* back face */
    #ticketContainer .back {
        z-index:1;
        -webkit-transform: rotateY(180deg) translateZ(0.1px);
                transform: rotateY(180deg) translateZ(0.1px);
        background:#ece3d6;
    }

    /* Front content */
    #canvasContainer { position:relative; }
    canvas {
        max-width:100vw;
        max-height:100vh;
        width:auto; height:auto;
        image-rendering:crisp-edges;
        display:block;
    }
    /* animated layer C on front */
    #layerCImg {
        position:absolute;
        top:50%; left:50%;
        transform:translate(-50%,-50%);
        max-width:100%; max-height:100%;
        pointer-events:none;
    }

    /* Back content container */
    #canvasContainerBack {
        position:relative;
        width:100%; height:100%;
    }
    #backImg {
        width:100%; height:100%;
        display:block;
    }
    /* overlay layer C on back */
    #layerCImgBack {
        position:absolute;
        top:50%; left:50%;
        transform:translate(-50%,-50%);
        max-width:100%; max-height:100%;
        pointer-events:none;
    }

    /* QR overlay */
    #qrCanvasOverlay {
        position:absolute;
        bottom:5%; left:50%;
        transform:translateX(-50%);
        width:38.5%; aspect-ratio:1;
        pointer-events:none;
        opacity:1;
        transition:opacity 300ms ease-in-out;
    }

    /* Check-in pill button */
    #checkDetails {
        position:absolute;
        top:14%; left:50%;
        transform:translateX(-50%);
        background:rgba(255,255,255,0.3);
        padding:8px 20px;
        border-radius:999px;
        font-family:"Helvetica Neue",sans-serif;
        font-weight:800;
        text-transform:uppercase;
        font-size:14px;
        color:#fff;
        text-decoration:none;
        letter-spacing:1px;
        backdrop-filter:blur(4px);
        cursor:pointer;
        transition:background 200ms ease;
        z-index:10;
    }
    #checkDetails:hover {
        background:rgba(255,255,255,0.5);
    }

    /* Modal overlay */
    #modalOverlay {
        display:none;
        position:fixed;
        top:0; left:0;
        width:100vw; height:100vh;
        background:rgba(0,0,0,0.5);
        justify-content:center;
        align-items:center;
        z-index:10000;
    }
    #modalBox {
        position:relative;
        width:80vw; height:80vh;
        background:#fff;
        border-radius:8px;
        overflow:hidden;
    }
    #modalClose {
        position:absolute;
        top:8px; right:8px;
        background:transparent;
        border:none;
        font-size:24px;
        cursor:pointer;
        z-index:10001;
    }
    #modalBox iframe {
        width:100%; height:100%; border:none;
    }
  </style>
</head>
<body>

  <div id="ticketContainer">
    <div class="flipper">
      <!-- FRONT -->
      <div class="front">
        <div id="canvasContainer">
          <canvas id="ticketCanvas"></canvas>
          <img id="layerCImg" src="/ticket/scrtxt.gif" alt="" />
          <div id="qrCanvasOverlay"></div>
          <a id="checkDetails">Check in details</a>
        </div>
      </div>
      <!-- BACK -->
      <div class="back">
        <div id="canvasContainerBack">
          <img id="backImg" src="/ticket/bMAIN.png" alt="" />
          <img id="layerCImgBack" src="/ticket/scrtxt.gif" alt="" />
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalOverlay">
    <div id="modalBox">
      <button id="modalClose">&times;</button>
      <iframe src="/ticket/modal.html"></iframe>
    </div>
  </div>

  <script src="../js/firebaseConfig.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
    firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    function loadPhone() {
      try { return localStorage.getItem('userPhone'); } catch {}
      const m = document.cookie.match(/(?:^|; )userPhone=(\d{10})/);
      return m ? m[1] : null;
    }
    async function getMemberDoc(phone) {
      const ref = db.collection('members').doc(phone);
      try {
        const snap = await ref.get({ source: 'cache' });
        if (snap.exists) return snap;
      } catch {}
      return ref.get();
    }
    function randomNoise(n) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      return Array.from({ length: n }, () => 
        chars.charAt(Math.floor(Math.random() * chars.length))
      ).join('');
    }
    function encryptText(txt) {
      return randomNoise(5) + btoa(txt) + randomNoise(5);
    }
    function pad2(n) { return String(n).padStart(2,'0'); }
    function nowStr() {
      const d=new Date();
      return pad2(d.getMonth()+1)+pad2(d.getDate())+
             pad2(d.getHours())  +pad2(d.getMinutes())+
             pad2(d.getSeconds());
    }

    const QR_REFRESH = 4;
    const COLORS = { green:"#5c5146", gold:"#b49e85" };

    // Elements & imgs
    const ticketContainer = document.getElementById('ticketContainer'),
          canvas          = document.getElementById('ticketCanvas'),
          ctx             = canvas.getContext('2d'),
          container       = document.getElementById('canvasContainer'),
          overlay         = document.getElementById('qrCanvasOverlay'),
          link            = document.getElementById('checkDetails'),
          modalOv         = document.getElementById('modalOverlay'),
          modalCl         = document.getElementById('modalClose'),
          mainImg         = new Image(),
          layerA          = new Image(),
          layerB          = new Image();

    let memberName='', flickerIndex=0, flickerLayers;

    async function init() {
      const phone=loadPhone();
      if(!phone) return alert('⚠️ No phone found – login first.');
      const snap=await getMemberDoc(phone);
      if(snap.exists) memberName=snap.data().name||'';

      mainImg.src='/ticket/MAIN.png';
      layerA.src='/ticket/layer_a.png';
      layerB.src='/ticket/layer_b.png';
      await Promise.all([mainImg.decode(),layerA.decode(),layerB.decode()]);

      flickerLayers=[layerA,layerB];

      canvas.width=mainImg.width;
      canvas.height=mainImg.height;

      requestAnimationFrame(()=>{
        const r=container.getBoundingClientRect();
        ticketContainer.style.width=`${r.width}px`;
        ticketContainer.style.height=`${r.height}px`;
      });

      drawFrame();
      setInterval(()=>{
        flickerIndex=(flickerIndex+1)%flickerLayers.length;
        drawFrame();
      },500);

      generateQr();
      setInterval(generateQr,QR_REFRESH*1000);
    }

    function drawFrame(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(mainImg,0,0);
      const f=flickerLayers[flickerIndex],
            fx=(canvas.width-f.width)/2,
            fy=(canvas.height-f.height)/2;
      ctx.drawImage(f,fx,fy);

      ctx.font='bold 48px "Helvetica Neue",sans-serif';
      ctx.fillStyle='#fff';
      ctx.textAlign='center';
      ctx.textBaseline='top';
      ctx.fillText(memberName,canvas.width/2,canvas.height*0.08);
    }

    function generateQr(){
      overlay.style.opacity=0;
      setTimeout(()=>{
        overlay.innerHTML='';
        const phone=loadPhone(),
              payload=nowStr()+'R'+phone,
              cipher=encryptText(payload),
              size=overlay.clientWidth;
        new QRCode(overlay,{
          text:cipher,
          width:size,
          height:size,
          colorDark:COLORS.green,
          colorLight:'transparent'
        });
        overlay.style.opacity=1;
      },300);
    }

    ticketContainer.addEventListener('click',()=>{
      ticketContainer.classList.toggle('flipped');
    });
    link.addEventListener('click',e=>{
      e.preventDefault(); e.stopPropagation();
      modalOv.style.display='flex';
    });

    modalCl.addEventListener('click',()=>modalOv.style.display='none');
    modalOv.addEventListener('click',()=>modalOv.style.display='none');
    document.getElementById('modalBox').addEventListener('click',e=>e.stopPropagation());

    init().catch(console.error);
  </script>
</body>
</html>
