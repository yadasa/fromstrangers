<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta property="og:image" content="https://firebasestorage.googleapis.com/v0/b/fromstrangerssocial.firebasestorage.app/o/photos%2Fy8nps3Miv4IF1CWjUcLU?alt=media&token=fc6cc646-942e-4b3d-a49d-b359f8dae1ac" />
  <title>Boat Ticket</title>
  <style>
    /* prevent selection */
    html, body, #ticketContainer, #ticketContainer *, #modalOverlay, #modalOverlay * {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      background:#ece3d6;
    }
    body {
      display:flex;
      justify-content:center;
      align-items:center;
      position: relative;
    }

    /* Login overlay */
    #phone-entry {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: #ece3d6;
      z-index: 10003;
    }
    #loginIframe {
      width:100%; height:100%; border:none;
    }

    /* Logo overlay */
    #logoOverlay {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10002;
    }
    #logoOverlay img {
      height: 40px;
      width: auto;
      display: block;
    }
    #logoOverlay img:active {
      transform: scale(1.1);
      filter: invert(1);
    }

    /* Flip container */
    #ticketContainer {
      perspective: 1000px;
      display:inline-block;
      overflow:visible;
      transform: translateY(120%);
      opacity:0;
      transition: transform 0.6s ease-out, opacity 0.6s ease-out;
      z-index: 1;
    }
    #ticketContainer.ready {
      transform: translateY(0);
      opacity:1;
    }
    #ticketContainer .flipper {
      position:relative;
      width:100%; height:100%;
      transform-style: preserve-3d;
      transform: rotateY(180deg);
      transition: transform 0.6s;
      cursor:pointer;
    }
    #ticketContainer.flipped .flipper {
      transform: rotateY(0deg);
    }
    #ticketContainer .front,
    #ticketContainer .back {
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      backface-visibility: hidden;
    }
    #ticketContainer .front {
      z-index:2;
      transform: rotateY(0deg) translateZ(0.1px);
    }
    #ticketContainer .back {
      z-index:1;
      transform: rotateY(180deg) translateZ(0.1px);
      background:#ece3d6;
    }

    /* Canvas and layers */
    #canvasContainer { position:relative; }
    canvas {
      max-width:100vw;
      max-height:100vh;
      width:auto; height:auto;
      image-rendering:crisp-edges;
      display:block;
    }
    #layerCImg {
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      max-width:100%; max-height:100%;
      pointer-events:none;
    }
    #canvasContainerBack { position:relative; width:100%; height:100%; }
    #backImg { width:100%; height:100%; display:block; }
    #layerCImgBack {
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      max-width:100%; max-height:100%;
      pointer-events:none;
    }

    /* QR overlay */
    #qrCanvasOverlay {
      position:absolute;
      bottom:5%; left:50%;
      transform:translateX(-50%);
      width:38.5%; aspect-ratio:1;
      pointer-events:none;
      opacity:1;
      transition:opacity 300ms ease-in-out;
    }

    /* Check-in button */
    #checkDetails {
      position:absolute;
      top:14%; left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.3);
      padding:8px 20px;
      border-radius:999px;
      font-family:"Helvetica Neue",sans-serif;
      font-weight:800;
      text-transform:uppercase;
      font-size:14px;
      color:#fff;
      letter-spacing:1px;
      backdrop-filter:blur(4px);
      cursor:pointer;
      transition:background 200ms ease;
      z-index:10;
    }
    #checkDetails:hover {
      background:rgba(255,255,255,0.5);
    }

    /* Modal */
    #modalOverlay {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100vw; height:100vh;
      background:rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
      z-index:10000;
    }
    #modalBox {
      position:relative;
      width:80vw; height:80vh;
      background:#fff;
      border-radius:8px;
      overflow:hidden;
    }
    #modalClose {
      position:absolute;
      top:8px; right:8px;
      background:transparent;
      border:none;
      font-size:24px;
      cursor:pointer;
      z-index:10001;
    }
    #modalBox iframe {
      width:100%; height:100%; border:none;
    }

    /* Error */
    #errorMessage {
      color:#333;
      font-size:1.25rem;
      text-align:center;
      padding:1rem;
    }
  </style>
</head>
<body>

  <!-- 1) Login iframe -->
  <div id="phone-entry">
    <iframe id="loginIframe" src="/login"></iframe>
  </div>

  <!-- 2) Logo -->
  <div id="logoOverlay">
    <a href="/"><img src="../assets/mainlogo.png" alt="Home" /></a>
  </div>

  <!-- 3) Ticket -->
  <div id="ticketContainer">
    <div class="flipper">
      <div class="front">
        <div id="canvasContainer">
          <canvas id="ticketCanvas"></canvas>
          <img id="layerCImg" src="/ticket/scrtxt.gif" alt="" />
          <div id="qrCanvasOverlay"></div>
          <a id="checkDetails">Check in details</a>
        </div>
      </div>
      <div class="back">
        <div id="canvasContainerBack">
          <img id="backImg" src="/ticket/bMAIN.png" alt="" />
          <img id="layerCImgBack" src="/ticket/scrtxt.gif" alt="" />
        </div>
      </div>
    </div>
  </div>

  <!-- 4) Modal -->
  <div id="modalOverlay">
    <div id="modalBox">
      <button id="modalClose">&times;</button>
      <iframe src="/ticket/modal.html"></iframe>
    </div>
  </div>

  <!-- Firebase + QR libs -->
  <script src="../js/firebaseConfig.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // ─── Init & Globals ────────────────────────────────────────
    firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    let flickerTimer = null;
    let qrTimer      = null;
    const QR_REFRESH = 4;
    const COLORS     = { green:"#5c5146", gold:"#b49e85" };
    let memberName   = '', flickerIndex = 0, flickerLayers;
    const mainImg = new Image(), layerA = new Image(), layerB = new Image();

    // ─── Persist / load phone ───────────────────────────────────
    function savePhone(phone) {
      try { localStorage.setItem('userPhone', phone); } catch {}
      document.cookie = `userPhone=${phone};max-age=${60*60*24*365};path=/;SameSite=Lax`;
    }
    function loadPhone() {
      try { return localStorage.getItem('userPhone'); } catch { return null; }
    }

    // ─── Listen for login iframe postMessage ────────────────────
    window.addEventListener('message', e => {
      if (e.origin !== window.location.origin) return;
      if (e.data?.type === 'loginSuccess') {
        savePhone(e.data.phone);
        document.getElementById('phone-entry').remove();
        init().catch(console.error);
      }
    });

    // ─── Auto-init if already logged in ────────────────────────
    if (loadPhone()) {
      document.getElementById('phone-entry').style.display = 'none';
      init().catch(console.error);
    }

    // ─── Firestore helper & error UI ──────────────────────────
    async function getMemberDoc(phone) {
      const ref = db.collection('members').doc(phone);
      try {
        const snap = await ref.get({ source: 'cache' });
        if (snap.exists) return snap;
      } catch {}
      return ref.get();
    }
    function showNoTicketError() {
      document.getElementById('ticketContainer')?.remove();
      document.getElementById('modalOverlay')?.remove();
      const msg = document.createElement('div');
      msg.id = 'errorMessage';
      msg.innerText = '❌ No ticket found for this event.';
      document.body.append(msg);
    }

    // ─── Core init (runs exactly once per login or reload) ─────
    async function init() {
      const phone = loadPhone();
      if (!phone) return;                    // not signed in yet
      const snap  = await getMemberDoc(phone);
      if (!snap.exists) return showNoTicketError();
      const data  = snap.data();
      memberName  = data.name || '';
      if (!data.bp) return showNoTicketError();

      // load images
      mainImg.src = '/ticket/MAIN.png';
      layerA.src  = '/ticket/layer_a.png';
      layerB.src  = '/ticket/layer_b.png';
      await Promise.all([ mainImg.decode(), layerA.decode(), layerB.decode() ]);
      flickerLayers = [ layerA, layerB ];

      // size canvas & container
      const canvas = document.getElementById('ticketCanvas');
      canvas.width  = mainImg.width;
      canvas.height = mainImg.height;
      requestAnimationFrame(() => {
        const rect = document.getElementById('canvasContainer').getBoundingClientRect();
        const tc = document.getElementById('ticketContainer');
        tc.style.width  = rect.width + 'px';
        tc.style.height = rect.height + 'px';
      });

      // initial draw
      drawFrame();

      // ―― boatStatus override? ――
      const status = data.boatStatus; // expects 'A' or 'B'
      if (status === 'A' || status === 'B') {
        // stop any flicker
        if (flickerTimer) {
          clearInterval(flickerTimer);
          flickerTimer = null;
        }
        // lock onto layer A (0) or B (1)
        flickerIndex = (status === 'A') ? 0 : 1;
        drawFrame();
      } else {
        // normal flicker
        if (!flickerTimer) {
          flickerTimer = setInterval(() => {
            flickerIndex = (flickerIndex + 1) % flickerLayers.length;
            drawFrame();
          }, 500);
        }
      }

      // ─── QR regen ──────────────────────────────────────────────
      generateQr();
      if (!qrTimer) {
        qrTimer = setInterval(generateQr, QR_REFRESH * 1000);
      }

      // slide into view
      document.getElementById('ticketContainer').classList.add('ready');
    }

    // ─── draw + QR helpers ─────────────────────────────────────
    function drawFrame() {
      const canvas = document.getElementById('ticketCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(mainImg,0,0);
      const f = flickerLayers[flickerIndex];
      const fx = (canvas.width - f.width)/2;
      const fy = (canvas.height - f.height)/2;
      ctx.drawImage(f,fx,fy);
      ctx.font = 'bold 48px "Helvetica Neue", sans-serif';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(memberName, canvas.width/2, canvas.height*0.08);
    }
    function generateQr() {
      const overlay = document.getElementById('qrCanvasOverlay');
      overlay.style.opacity = 0;
      setTimeout(() => {
        overlay.innerHTML = '';
        const phone   = loadPhone();
        const payload = `${nowStr()}R${phone}`;
        const cipher  = randomNoise(5) + btoa(payload) + randomNoise(5);
        const size    = overlay.clientWidth;
        new QRCode(overlay, {
          text:       cipher,
          width:      size,
          height:     size,
          colorDark:  COLORS.green,
          colorLight: 'transparent'
        });
        overlay.style.opacity = 1;
      }, 300);
    }
    function randomNoise(n) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      return Array.from({ length: n }, () =>
        chars.charAt(Math.floor(Math.random() * chars.length))
      ).join('');
    }
    function pad2(n) { return String(n).padStart(2,'0'); }
    function nowStr() {
      const d = new Date();
      return pad2(d.getMonth()+1)+pad2(d.getDate())
           + pad2(d.getHours())   + pad2(d.getMinutes())
           + pad2(d.getSeconds());
    }

    // ─── UI bindings ──────────────────────────────────────────
    document.getElementById('ticketContainer')
            .addEventListener('click', () =>
      document.getElementById('ticketContainer')
              .classList.toggle('flipped')
    );
    document.getElementById('checkDetails')
            .addEventListener('click', e => {
      e.preventDefault(); e.stopPropagation();
      document.getElementById('modalOverlay').style.display = 'flex';
    });
    document.getElementById('modalClose').onclick = () =>
      document.getElementById('modalOverlay').style.display = 'none';
    document.getElementById('modalOverlay').onclick = () =>
      document.getElementById('modalOverlay').style.display = 'none';
    document.getElementById('modalBox')
            .addEventListener('click', e => e.stopPropagation());
  </script>
</body>
</html>
