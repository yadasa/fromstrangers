<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ticket Details</title>
  <style>
    /* prevent selection */
    html, body, #ticketContainer, #ticketContainer *, #modalOverlay, #modalOverlay * {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      background:#ece3d6;
    }
    body {
      display:flex;
      justify-content:center;
      align-items:center;
    }

    /* Logo overlay */
    #logoOverlay {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10002;
    }
    #logoOverlay img {
      height: 40px;
      width: auto;
      display: block;
    }

    #logoOverlay img:active {
        transform: scale(1.1);
        filter: invert(1);
        }

    /* Flip container */
    #ticketContainer {
      -webkit-perspective: 1000px;
              perspective: 1000px;
      display:inline-block;
      overflow:visible;
    }
    #ticketContainer .flipper {
      position:relative;
      width:100%; height:100%;
      -webkit-transform-style: preserve-3d;
              transform-style: preserve-3d;
      will-change: transform;
      -webkit-transform: rotateY(180deg) translateZ(0);
              transform: rotateY(180deg) translateZ(0);
      -webkit-transition: -webkit-transform 0.6s;
              transition: transform 0.6s;
      cursor:pointer;
    }
    /* when “flipped” class is present: rotate to 0°, showing front */
    #ticketContainer.flipped .flipper {
      -webkit-transform: rotateY(0deg) translateZ(0);
              transform: rotateY(0deg) translateZ(0);
    }

    /* Front & back faces */
    #ticketContainer .front,
    #ticketContainer .back {
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      -webkit-backface-visibility: hidden;
              backface-visibility: hidden;
      will-change: transform, opacity;
    }
    /* front face */
    #ticketContainer .front {
      z-index:2;
      -webkit-transform: rotateY(0deg) translateZ(0.1px);
              transform: rotateY(0deg) translateZ(0.1px);
    }
    /* back face */
    #ticketContainer .back {
      z-index:1;
      -webkit-transform: rotateY(180deg) translateZ(0.1px);
              transform: rotateY(180deg) translateZ(0.1px);
      background:#ece3d6;
    }

    /* Front content */
    #canvasContainer { position:relative; }
    canvas {
      max-width:100vw;
      max-height:100vh;
      width:auto; height:auto;
      image-rendering:crisp-edges;
      display:block;
    }
    /* animated layer C on front */
    #layerCImg {
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      max-width:100%; max-height:100%;
      pointer-events:none;
    }

    /* Back content container */
    #canvasContainerBack {
      position:relative;
      width:100%; height:100%;
    }
    #backImg {
      width:100%; height:100%;
      display:block;
    }
    /* overlay layer C on back */
    #layerCImgBack {
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      max-width:100%; max-height:100%;
      pointer-events:none;
    }

    /* QR overlay */
    #qrCanvasOverlay {
      position:absolute;
      bottom:5%; left:50%;
      transform:translateX(-50%);
      width:38.5%; aspect-ratio:1;
      pointer-events:none;
      opacity:1;
      transition:opacity 300ms ease-in-out;
    }

    /* Check-in pill button */
    #checkDetails {
      position:absolute;
      top:14%; left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.3);
      padding:8px 20px;
      border-radius:999px;
      font-family:"Helvetica Neue",sans-serif;
      font-weight:800;
      text-transform:uppercase;
      font-size:14px;
      color:#fff;
      text-decoration:none;
      letter-spacing:1px;
      backdrop-filter:blur(4px);
      cursor:pointer;
      transition:background 200ms ease;
      z-index:10;
    }
    #checkDetails:hover {
      background:rgba(255,255,255,0.5);
    }

    /* Modal overlay */
    #modalOverlay {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100vw; height:100vh;
      background:rgba(0,0,0,0.5);
      justify-content:center;
      align-items:center;
      z-index:10000;
    }
    #modalBox {
      position:relative;
      width:80vw; height:80vh;
      background:#fff;
      border-radius:8px;
      overflow:hidden;
    }
    #modalClose {
      position:absolute;
      top:8px; right:8px;
      background:transparent;
      border:none;
      font-size:24px;
      cursor:pointer;
      z-index:10001;
    }
    #modalBox iframe {
      width:100%; height:100%; border:none;
    }

    /* Error message */
    #errorMessage {
      color:#333;
      font-size:1.25rem;
      text-align:center;
      padding:1rem;
    }
  </style>
</head>
<body>

  <!-- Logo fixed overlay -->
  <div id="logoOverlay">
    <a href="/"><img src="../assets/mainlogo.png" alt="Home" /></a>
  </div>

  <div id="ticketContainer">
    <div class="flipper">
      <!-- FRONT -->
      <div class="front">
        <div id="canvasContainer">
          <canvas id="ticketCanvas"></canvas>
          <img id="layerCImg" src="/ticket/scrtxt.gif" alt="" />
          <div id="qrCanvasOverlay"></div>
          <a id="checkDetails">Check in details</a>
        </div>
      </div>
      <!-- BACK -->
      <div class="back">
        <div id="canvasContainerBack">
          <img id="backImg" src="/ticket/bMAIN.png" alt="" />
          <img id="layerCImgBack" src="/ticket/scrtxt.gif" alt="" />
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalOverlay">
    <div id="modalBox">
      <button id="modalClose">&times;</button>
      <iframe src="/ticket/modal.html"></iframe>
    </div>
  </div>

  <script src="../js/firebaseConfig.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    function loadPhone() {
      try { return localStorage.getItem('userPhone'); } catch { return null; }
      const m = document.cookie.match(/(?:^|; )userPhone=(\d{10})/);
      return m ? m[1] : null;
    }

    async function getMemberDoc(phone) {
      const ref = db.collection('members').doc(phone);
      try {
        const snap = await ref.get({ source: 'cache' });
        if (snap.exists) return snap;
      } catch {}
      return ref.get();
    }

    function showNoTicketError() {
      document.getElementById('ticketContainer')?.remove();
      document.getElementById('modalOverlay')?.remove();
      const msg = document.createElement('div');
      msg.id = 'errorMessage';
      msg.innerText = '❌ No ticket found for this event.';
      document.body.append(msg);
    }

    /* Flicker layers & QR */
    const QR_REFRESH = 4;
    const COLORS = { green:"#5c5146", gold:"#b49e85" };
    let memberName = '', flickerIndex=0, flickerLayers;
    const mainImg = new Image(),
          layerA  = new Image(),
          layerB  = new Image();

    async function init() {
      const phone = loadPhone();
      if (!phone) {
        return showNoTicketError();
      }

      const snap = await getMemberDoc(phone);
      if (!snap.exists) {
        return showNoTicketError();
      }
      const data = snap.data();
      memberName = data.name || '';

      // If bP !== true, bail out
      if (!data.bp) {
        return showNoTicketError();
      }

      // load images
      mainImg.src = '/ticket/MAIN.png';
      layerA.src  = '/ticket/layer_a.png';
      layerB.src  = '/ticket/layer_b.png';
      await Promise.all([ mainImg.decode(), layerA.decode(), layerB.decode() ]);

      flickerLayers = [ layerA, layerB ];

      // size canvas
      const canvas = document.getElementById('ticketCanvas');
      canvas.width  = mainImg.width;
      canvas.height = mainImg.height;

      // size container to match
      requestAnimationFrame(() => {
        const rect = document.getElementById('canvasContainer').getBoundingClientRect();
        const tc = document.getElementById('ticketContainer');
        tc.style.width  = rect.width + 'px';
        tc.style.height = rect.height + 'px';
      });

      drawFrame();
      setInterval(() => {
        flickerIndex = (flickerIndex + 1) % flickerLayers.length;
        drawFrame();
      }, 500);

      generateQr();
      setInterval(generateQr, QR_REFRESH * 1000);
    }

    function drawFrame() {
      const canvas = document.getElementById('ticketCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(mainImg,0,0);
      const f = flickerLayers[flickerIndex];
      const fx = (canvas.width - f.width)/2;
      const fy = (canvas.height - f.height)/2;
      ctx.drawImage(f,fx,fy);
      ctx.font = 'bold 48px "Helvetica Neue", sans-serif';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(memberName, canvas.width/2, canvas.height*0.08);
    }

    function generateQr() {
      const overlay = document.getElementById('qrCanvasOverlay');
      overlay.style.opacity = 0;
      setTimeout(() => {
        overlay.innerHTML = '';
        const phone = loadPhone();
        const payload = `${nowStr()}R${phone}`;
        const cipher  = encryptText(payload);
        const size    = overlay.clientWidth;
        new QRCode(overlay, {
          text:       cipher,
          width:      size,
          height:     size,
          colorDark:  COLORS.green,
          colorLight: 'transparent'
        });
        overlay.style.opacity = 1;
      }, 300);
    }

    function randomNoise(n) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      return Array.from({ length: n }, () =>
        chars.charAt(Math.floor(Math.random() * chars.length))
      ).join('');
    }
    function encryptText(txt) {
      return randomNoise(5) + btoa(txt) + randomNoise(5);
    }
    function pad2(n) { return String(n).padStart(2,'0'); }
    function nowStr() {
      const d = new Date();
      return pad2(d.getMonth()+1)+pad2(d.getDate())
           + pad2(d.getHours())   + pad2(d.getMinutes())
           + pad2(d.getSeconds());
    }

    // flip handler
    document.getElementById('ticketContainer').addEventListener('click', () => {
      document.getElementById('ticketContainer').classList.toggle('flipped');
    });
    // check details
    document.getElementById('checkDetails').addEventListener('click', e => {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('modalOverlay').style.display = 'flex';
    });
    // modal close
    document.getElementById('modalClose').addEventListener('click', () => {
      document.getElementById('modalOverlay').style.display = 'none';
    });
    document.getElementById('modalOverlay').addEventListener('click', () => {
      document.getElementById('modalOverlay').style.display = 'none';
    });
    document.getElementById('modalBox').addEventListener('click', e => e.stopPropagation());

    init().catch(console.error);
  </script>
</body>
</html>
