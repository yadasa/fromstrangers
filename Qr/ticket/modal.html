<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket Details</title>
  <style>
    * { user-select: none; -webkit-user-select: none; }
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      background:#ece3d6;
      font-family:"Helvetica Neue",sans-serif;
      color:#333;
    }
    body {
      display:flex; justify-content:center; align-items:center;
      padding:1rem;
    }
    .card {
      background:#f5efe6; border-radius:12px;
      max-width:400px; width:100%; padding:1.5rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      position:relative;
    }
    h1 {
      font-size:1.25rem; color:#5c5146;
      text-align:center; margin-bottom:0.5rem;
    }
    #userName {
      text-align:center; font-weight:600;
      color:#5c5146; margin-bottom:1rem;
    }
    .question { margin-bottom:1rem; transition:opacity 200ms ease; }
    .question.disabled { opacity:0.5; pointer-events:none; }
    .question label { display:block; font-weight:600; margin-bottom:0.5rem; }
    .question a { color:#5c5146; text-decoration:underline; cursor:pointer; }
    .question input { margin-right:0.5rem; transform:scale(1.2); }
    #showBoat, #editBtn {
      width:100%; padding:0.75rem; border:none; border-radius:999px;
      background:rgba(92,81,70,0.3); color:#fff;
      font-weight:800; text-transform:uppercase; letter-spacing:1px;
      cursor:not-allowed; transition:background 200ms ease;
      margin-top:1rem;
    }
    #showBoat.enabled, #editBtn.enabled {
      background:#5c5146; cursor:pointer;
    }
    .iframeOverlay {
      display:none; position:fixed; top:0; left:0;
      width:100vw; height:100vh;
      background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center;
      z-index:2000;
    }
    .iframeOverlay iframe {
      width:90vw; height:90vh;
      border:none; border-radius:8px;
    }
    .iframeOverlay button {
      position:absolute; top:10px; right:10px;
      font-size:1.5rem; background:transparent;
      border:none; color:#fff; cursor:pointer;
    }
    #countdown {
      font-size:2rem; text-align:center; color:#5c5146;
      margin-top:1rem;
    }
    /* Terms modal: use <pre> to preserve raw RTF styling */
    #tncOverlay pre {
      width:40vw; height:50vh;
      background:#fff; border-radius:8px;
      padding:1rem; overflow:auto;
      white-space:pre-wrap; word-wrap:break-word;
      font-family:monospace; font-size:0.9rem;
      margin:0;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Form -->
    <div id="formContainer">
      <h1>Check-In Details</h1>
      <div id="userName"></div>

      <div id="q1" class="question">
        <label><input type="checkbox" id="waiverChk" /> Have you filled out your waiver?</label>
        <span>If not, <a id="waiverLink">click here</a>.</span>
      </div>

      <div id="q2" class="question disabled">
        <label>Do you want to ride the jet ski(s)?</label>
        <label><input type="radio" name="jet" value="yes" /> Yes</label>
        <label><input type="radio" name="jet" value="no"  /> No</label>
      </div>

      <div id="q3" class="question disabled">
        <label>Do you have a preference for which boat?</label>
        <label><input type="radio" name="boat" value="Yes" /> Yes</label>
        <label><input type="radio" name="boat" value="No"  /> No</label>
      </div>

      <div id="q4" class="question disabled">
        <label>
          <input type="checkbox" id="vibesChk" />
          <a id="vibeLink">Set your vibe preferences</a>
        </label>
      </div>

      <div id="q5" class="question disabled">
        <label><input type="checkbox" id="tncChk" /> I agree to the <a id="tncLink">terms &amp; conditions</a>.</label>
      </div>

      <button id="showBoat">Show Me My Boat</button>
    </div>

    <!-- Countdown -->
    <div id="countdownContainer" style="display:none">
      <h1>boat reveal in:</h1>
      <div id="countdown">--:--:--</div>
      <button id="editBtn" class="enabled">Edit Responses</button>
    </div>
  </div>

  <!-- Overlays -->
  <div id="waiverOverlay" class="iframeOverlay">
    <button id="waiverClose">&times;</button>
    <iframe id="waiverIframe"></iframe>
  </div>
  <div id="vibeOverlay" class="iframeOverlay">
    <button id="vibeClose">&times;</button>
    <iframe src="/vibes.html"></iframe>
  </div>
  <div id="tncOverlay" class="iframeOverlay" style="background:rgba(0,0,0,0.6);">
    <div style="margin-top:8px;color:#8a7567;text-align:center;font-size:0.9rem;">
      Tap anywhere to close
      <button id="tncClose">&times;</button>
      <pre id="tncBox">Loading terms…</pre>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../js/firebaseConfig.js"></script>
  <script>
    firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    function loadPhone() { try { return localStorage.getItem('userPhone'); } catch { return null; } }
    async function getMemberDoc(p){
      const r = db.collection('members').doc(p);
      try { const s = await r.get({source:'cache'}); if(s.exists) return s; }
      catch{}
      return r.get();
    }

    (async ()=>{
      const phone = loadPhone();
      if(!phone) { alert('No phone found'); return; }
      const memSnap = await getMemberDoc(phone);
      if(!memSnap.exists) { alert('Member not found'); return; }
      const name = memSnap.data().name || '';

      // Elements
      const formC     = document.getElementById('formContainer'),
            cntC      = document.getElementById('countdownContainer'),
            qEls      = ['q1','q2','q3','q4','q5'].map(id=>document.getElementById(id)),
            waiverChk = document.getElementById('waiverChk'),
            vibesChk  = document.getElementById('vibesChk'),
            tncChk    = document.getElementById('tncChk'),
            showBtn   = document.getElementById('showBoat'),
            editBtn   = document.getElementById('editBtn'),
            countdown = document.getElementById('countdown'),
            userName  = document.getElementById('userName'),
            wlLink    = document.getElementById('waiverLink'),
            wlOv      = document.getElementById('waiverOverlay'),
            wlIf      = document.getElementById('waiverIframe'),
            wlClose   = document.getElementById('waiverClose'),
            vbLink    = document.getElementById('vibeLink'),
            vbOv      = document.getElementById('vibeOverlay'),
            vbClose   = document.getElementById('vibeClose'),
            tncLink   = document.getElementById('tncLink'),
            tncOv     = document.getElementById('tncOverlay'),
            tncClose  = document.getElementById('tncClose'),
            tncBox    = document.getElementById('tncBox');

      userName.textContent = name;

      // waiver URLs
      const waiverUrls = [
        'https://mono.wherewolf.co.nz/0343dcb2de48…',
        'https://mono.wherewolf.co.nz/59e13a73b109…'
      ];

      // waiver overlay logic
      wlLink.onclick = e=>{
        e.preventDefault();
        const url = waiverUrls[Math.floor(Math.random()*waiverUrls.length)];
        wlIf.src = url;
        wlOv.style.display = 'flex';
      };
      wlClose.onclick = ()=> wlOv.style.display = 'none';
      wlOv.onclick    = e=>{ if(e.target===wlOv) wlOv.style.display='none'; };

      // vibe overlay logic
      vbLink.onclick = e=>{
        e.preventDefault();
        vbOv.style.display = 'flex';
      };
      vbClose.onclick = ()=>{
        vbOv.style.display = 'none';
        vibesChk.checked = true;
        vibesChk.dispatchEvent(new Event('change'));
      };
      vbOv.onclick = e=>{
        if(e.target===vbOv){
          vbOv.style.display='none';
          vibesChk.checked = true;
          vibesChk.dispatchEvent(new Event('change'));
        }
      };

      // Terms modal logic
      let tncLoaded = false;
      async function loadTnC(){
        if(tncLoaded) return;
        try {
          const txt = await fetch('/ticket/fstc.rtf').then(r=>r.text());
          tncBox.textContent = txt;
        } catch {
          tncBox.textContent = 'Unable to load Terms & Conditions.';
        }
        tncLoaded = true;
      }
      tncLink.onclick = async e=>{
        e.preventDefault();
        await loadTnC();
        tncOv.style.display = 'flex';
      };
      tncClose.onclick = ()=> tncOv.style.display='none';
      tncOv.onclick    = e=>{ if(e.target===tncOv) tncOv.style.display='none'; };

      // fetch last responses
      const lastSnap = await db.collection('members').doc(phone)
        .collection('boatParty').orderBy('timestamp','desc').limit(1).get();
      let resp = lastSnap.empty? null : lastSnap.docs[0].data();

      // countdown setup
      const target = new Date("2025-08-02T02:00:00Z");
      function startCountdown(){
        function up(){
          let d = target - new Date();
          if(d<0) d = 0;
          const h = String(Math.floor(d/3600000)).padStart(2,'0'),
                m = String(Math.floor(d%3600000/60000)).padStart(2,'0'),
                s = String(Math.floor(d%60000/1000)).padStart(2,'0');
          countdown.textContent = `${h}:${m}:${s}`;
        }
        up(); setInterval(up,1000);
      }

      function showCountdown(){
        formC.style.display='none';
        cntC.style.display='block';
        startCountdown();
        editBtn.onclick = ()=>{
          cntC.style.display='none';
          formC.style.display='block';
          qEls.forEach(q=>q.classList.remove('disabled'));
          tncChk.checked = true;
          tncChk.disabled = true;
          showBtn.classList.add('enabled');
          showBtn.disabled = false;
          loadForm(resp);
        };
      }

      // check complete
      const done = resp &&
        resp.waiver && resp.jet && resp.boatPref && resp.vibes && resp.terms;
      if(done){
        showCountdown();
        return;
      }

      // show form
      cntC.style.display='none';
      formC.style.display='block';

      // helpers
      const unlock = i=>qEls[i].classList.remove('disabled');
      const resetFrom = i=>{
        for(let j=i;j<qEls.length;j++){
          qEls[j].classList.add('disabled');
          qEls[j].querySelectorAll('input').forEach(inp=>inp.checked = false);
        }
        showBtn.classList.remove('enabled');
        showBtn.disabled = true;
      };
      const toggleShow = ok=>{
        showBtn.classList.toggle('enabled', ok);
        showBtn.disabled = !ok;
      };

      // preload
      function loadForm(r){
        if(!r) return;
        if(r.waiver){ waiverChk.checked=true; unlock(1); }
        if(r.jet){
          unlock(1);
          qEls[1].querySelector(`input[value="${r.jet}"]`).checked = true;
          unlock(2);
        }
        if(r.boatPref){
          unlock(2);
          qEls[2].querySelector(`input[value="${r.boatPref}"]`).checked = true;
          unlock(3);
        }
        if(r.vibes){
          unlock(3);
          vibesChk.checked = true;
          vibesChk.dispatchEvent(new Event('change'));
        }
        if(r.terms){
          tncChk.checked = true;
          unlock(4);
          toggleShow(true);
        }
      }
      loadForm(resp);

      // handlers
      waiverChk.onchange = ()=> waiverChk.checked? unlock(1): resetFrom(1);
      qEls[1].querySelectorAll('input').forEach(i=>i.onchange = ()=> unlock(2));
      qEls[2].querySelectorAll('input').forEach(i=>i.onchange = ()=> unlock(3));
      vibesChk.onchange = ()=> vibesChk.checked? unlock(4): resetFrom(4);
      tncChk.onchange = ()=> toggleShow(tncChk.checked);

      // submit
      showBtn.onclick = async ()=>{
        const answers = {
          waiver: waiverChk.checked,
          jet: qEls[1].querySelector('input:checked')?.value||'',
          boatPref: qEls[2].querySelector('input:checked')?.value||'',
          vibes: vibesChk.checked,
          terms: tncChk.checked,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('members').doc(phone)
          .collection('boatParty').add(answers);
        resp = answers;
        showCountdown();
      };

      // init
      showBtn.disabled = true;
    })();
  </script>
</body>
</html>
