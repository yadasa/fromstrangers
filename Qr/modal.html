<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ticket</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
    }
    body {
      background: #ece3d6;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #canvasContainer {
      position: relative;
    }
    canvas {
      max-width: 100vw;
      max-height: 100vh;
      width: auto;
      height: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      image-rendering: crisp-edges;
    }
    #qrCanvasOverlay {
      position: absolute;
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
      width: 38.5%;
      aspect-ratio: 1;
      pointer-events: none;
      opacity: 1;
      transition: opacity 300ms ease-in-out;
    }
    #checkDetails {
      position: absolute;
        top: 14%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.3);  /* semi-transparent white */
        padding: 8px 20px;                     /* vertical & horizontal padding */
        border-radius: 999px;                  /* full pill shape */
        font-family: "Helvetica Neue", sans-serif;
        font-weight: 800;                      /* heavy bold */
        text-transform: uppercase;             /* all caps */
        font-size: 14px;
        color: #ffffff;                        /* white text */
        text-decoration: none;                 /* no underline */
        letter-spacing: 1px;                   /* a little tracking */
        backdrop-filter: blur(4px);            /* optional frosted effect */
        cursor: pointer;
        transition: background 200ms ease;
    }

    #checkDetails:hover {
        background: rgba(255, 255, 255, 0.5);
        }
    /* modal overlay */
    #modalOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    #modalBox {
      position: relative;
      width: 80vw;
      height: 80vh;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    #modalClose {
      position: absolute;
      top: 8px; right: 8px;
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      z-index: 10001;
    }
    #modalBox iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>
<body>
  <div id="canvasContainer">
    <canvas id="ticketCanvas"></canvas>
    <div id="qrCanvasOverlay"></div>
    <a id="checkDetails">Check in details</a>
  </div>

  <!-- modal -->
  <div id="modalOverlay">
    <div id="modalBox">
      <button id="modalClose">&times;</button>
      <iframe src="/ticket/modal.html"></iframe>
    </div>
  </div>

  <script src="../js/firebaseConfig.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // ── INIT FIREBASE ──────────────────────────────────────────────────────
    firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();

    // ── UTILS ───────────────────────────────────────────────────────────────
    function loadPhone() {
      try { return localStorage.getItem('userPhone'); } catch {}
      const m = document.cookie.match(/(?:^|; )userPhone=(\d{10})/);
      return m ? m[1] : null;
    }
    async function getMemberDoc(phone) {
      const ref = db.collection('members').doc(phone);
      try {
        const snap = await ref.get({ source: 'cache' });
        if (snap.exists) return snap;
      } catch {}
      return ref.get();
    }
    function randomNoise(n) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      return Array.from({ length: n }, () =>
        chars.charAt(Math.floor(Math.random() * chars.length))
      ).join('');
    }
    function encryptText(txt) {
      return randomNoise(5) + btoa(txt) + randomNoise(5);
    }
    function pad2(n) { return String(n).padStart(2, '0'); }
    function nowStr() {
      const d = new Date();
      return pad2(d.getMonth()+1) + pad2(d.getDate()) +
             pad2(d.getHours())   + pad2(d.getMinutes()) +
             pad2(d.getSeconds());
    }

    // ── SETTINGS ───────────────────────────────────────────────────────────
    const QR_REFRESH = 4;
    const COLORS     = { green: "#5c5146", gold: "#b49e85" };

    // ── LOAD IMAGES ────────────────────────────────────────────────────────
    const mainImg = new Image(),
          layerA  = new Image(),
          layerB  = new Image();
    mainImg.src = '/ticket/MAIN.png';
    layerA.src  = '/ticket/layer_a.png';
    layerB.src  = '/ticket/layer_b.png';

    // ── CANVAS & QR ELEMENTS ───────────────────────────────────────────────
    const canvas  = document.getElementById('ticketCanvas'),
          ctx     = canvas.getContext('2d'),
          overlay = document.getElementById('qrCanvasOverlay'),
          link    = document.getElementById('checkDetails'),
          modalOv = document.getElementById('modalOverlay'),
          modalCl = document.getElementById('modalClose');

    let memberName = '', toggle = false;

    async function init() {
      const phone = loadPhone();
      if (!phone) return alert('⚠️ No phone found – login first.');
      const snap = await getMemberDoc(phone);
      if (snap.exists) memberName = snap.data().name || '';

      await Promise.all([ mainImg.decode(), layerA.decode(), layerB.decode() ]);
      canvas.width  = mainImg.width;
      canvas.height = mainImg.height;

      drawFrame();
      setInterval(() => {
        toggle = !toggle;
        drawFrame();
      }, 500);

      generateQr();
      setInterval(generateQr, QR_REFRESH * 1000);
    }

    function drawFrame() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(mainImg, 0, 0);
      const ov = toggle ? layerB : layerA,
            x  = (canvas.width - ov.width)/2,
            y  = (canvas.height - ov.height)/2;
      ctx.drawImage(ov, x, y);

      ctx.font = 'bold 48px "Helvetica Neue", sans-serif';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(memberName, canvas.width/2, canvas.height*0.08);
    }

    function generateQr() {
      // fade out
      overlay.style.opacity = 0;
      setTimeout(() => {
        overlay.innerHTML = '';
        const phone   = loadPhone(),
              payload = nowStr() + 'R' + phone,
              cipher  = encryptText(payload),
              size    = overlay.clientWidth;

        new QRCode(overlay, {
          text:      cipher,
          width:     size,
          height:    size,
          colorDark: COLORS.green,
          colorLight:'transparent'
        });
        // fade in
        overlay.style.opacity = 1;
      }, 300);
    }

    // ── MODAL HANDLERS ─────────────────────────────────────────────────────
    link.addEventListener('click', e => {
      e.preventDefault();
      modalOv.style.display = 'flex';
    });
    modalCl.addEventListener('click', () => {
      modalOv.style.display = 'none';
    });
    modalOv.addEventListener('click', () => {
      modalOv.style.display = 'none';
    });
    // prevent clicks inside modalBox from closing
    document.getElementById('modalBox').addEventListener('click', e => {
      e.stopPropagation();
    });

    init().catch(console.error);
  </script>
</body>
</html>
